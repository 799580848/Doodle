$(function(){function e(e){return T[e]}function t(t){return t.replace(/[&<>"']/g,e)}function n(e){var n='<li><p class="comment-author"><img src="';n+=e.img,n+='?s=48&amp;d=monsterid" class="avatar" height="48" width="48"/><cite><a id="comment-id-',n+=e.id,e.url&&(n+='" href="'+t(e.url)),n+='">'+t(e.user_name)+"</a></cite>";var o=e.ua;if(o){n+='<span class="ua">';for(var a,i=0;i<o.length;++i)a=e.ua[i],n+='<img src="/static/img/ua/'+a.replace(/ /g,"-")+'.png" alt="'+a+'" title="'+a+'"/>';n+="</span>"}return n+="<br/><small><strong>"+e.time+'</strong></small></p><div class="commententry" id="commententry-'+e.id+'"><div>'+e.content+'</div></div><a class="comment-reply-link" href="#respond">回复</a></li>'}function o(e,t,n){e.find("a.comment-reply-link").click(function(){i(t,n)}),e.find('a[href^="#comment-id-"]').hover(function(e){var t=$(this).attr("href").substr(12),n=p.find("#comment-id-"+t);n.length&&h.css({top:e.pageY,left:e.pageX+50}).append(n.parent().parent().parent().clone().find("a.comment-reply-link").remove().end()).fadeTo(1e3,.9)},function(){h.hide().empty()}),e.find("pre>code").each(function(e,t){hljs.highlightBlock(t)})}function a(){var e=k;e+=v?"asc/":"desc/",e+=g,$.ajax({url:e,dataType:"json",error:function(e,t){"timeout"==t&&a()},success:function(e){var t=e.next_page;t?(g=t,y.show()):(m=!0,y.hide());var a=e.comments,i=a.length;if(i){for(var c=0;i>c;++c){var r=a[c],s=$(n(r)).appendTo(f);o(s,r.id,r.user_name)}f.children().unwrap().hide().appendTo(p).slideDown(1e3)}d=!1,ga_id&&ga("send","event","Comment","Load",null,article_id)},timeout:1e4})}function i(e,t){if(s){var n=c.val();n+="[url=#comment-id-",n+=e,n+="]@",n+=t,n+="[/url]: ",setTimeout(function(){c.focus().val(n)},100)}}var c,r,s,l=$(window),m=!1,d=!0,u=0,p=$("#commentlist>ol"),f=$("<ol/>"),h=$('<ol class="commentlist comment-float-list"/>').appendTo(document.body).hide(),g=1,v=!0,b=$("#comment-order-asc"),_=$("#comment-order-desc"),k=home_path+"article/"+article_id+"/comments/",y=$("#more-hint"),x=$("#respond"),T={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&apos;"};a(),hljs.configure({tabReplace:"    "}),$("pre>code").each(function(e,t){hljs.highlightBlock(t)}),$.extend({show_comment_form:function(e,a,i,l,m){if(m)x.append('<p>您需要<a href="'+m+'">登录</a>您的 Google 账号才能进行评论。</p>');else{x.append('<form action="'+a+'" method="post" id="commentform">	<p>您当前登录的用户为：'+t(e)+'，您可<a href="'+l+'">修改用户资料</a>，或<a href="'+i+'">登出</a>以更换用户。</p>	<p><textarea name="comment" id="comment" cols="58" rows="10" tabindex="1"></textarea></p>	<p><input name="bbcode" type="checkbox" id="bbcode" tabindex="2" checked="checked"/> <label for="bbcode">启用BBCode</label></p>	<p><small>小提示：回复某条回帖时，可以点击其右侧的“回复”按钮，这样该帖的作者会收到邮件通知。</small></p>	<p><input name="submit" type="submit" id="submit" tabindex="3" value="来一发"/></p></form>'),s=!0,c=$("#comment"),r=$("#commentform"),c.markItUp(BbcodeSettings),$("#comments").find("a").click(function(){c.focus()});var d=!1,u=r.find("#bbcode");r.submit(function(){if(d)return!1;d=!0;var e=$.trim(c.val());if(!e)return $.msgbox("拜托，你也写点内容再发表吧"),d=!1,!1;var t={comment:e};return u.attr("checked")&&(t.bbcode="on"),$.ajax({url:r.attr("action"),data:t,dataType:"json",type:"POST",error:function(){d=!1,$.msgbox("抱歉，遇到不明状况，发送失败了")},success:function(e){if(200==e.status){var t=e.comment,a=$(n(t));o(a,t.id,t.user_name),a.hide().appendTo(p).slideDown(1e3),c.val(""),$.msgbox("评论成功")}else $.msgbox(e.content);d=!1,ga_id&&ga("send","event","Comment","Reply",null,article_id)},timeout:1e4}),!1})}}}),b.click(function(){b.addClass("selected"),_.removeClass("selected"),v||(d=!0,p.empty(),v=!0,m=!1,g=1,a())}),_.click(function(){_.addClass("selected"),b.removeClass("selected"),v&&(d=!0,p.empty(),v=!1,m=!1,g=1,a())}),y.find("a").click(function(){m=!0,y.hide()}),l.scroll(function(e){var t=l.scrollTop();!m&&!d&&!_scrolling_status&&t>u&&l.scrollTop()+l.height()-x.offset().top-x.outerHeight()>20&&(d=!0,a()),u=t,2==_scrolling_status&&(_scrolling_status=0)})});